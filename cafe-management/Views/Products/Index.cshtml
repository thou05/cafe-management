@* @{
    ViewData["Title"] = "Sản phẩm";
    ViewData["Products"] = "active";
}

@using X.PagedList.Mvc.Core
@model X.PagedList.IPagedList<TbProduct>

<!-- Breadcrumb Begin -->
<div class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__links">
                    <a asp-controller="home" asp-action="index">
                        <i class="fas fa-home"></i>
                        Trang chủ
                    </a>
                    <span>Sản phẩm</span>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Breadcrumb End -->
<!-- Shop Section Begin -->
<section class="shop spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-3">
                <div class="shop__sidebar">
                    <div class="sidebar__categories">
                        <div class="section-title">
                            <h4>Loại sản phẩm</h4>
                        </div>
                        @await Component.InvokeAsync("NhomSpMenu")
                    </div>
                </div>
            </div>
            <div class="col-lg-9 col-md-9">
                <div class="products-title">
                    <h4>Danh sách sản phẩm</h4>
                </div>

                <div id="displayProducts" class="row">
                    @foreach (var item in Model)
                    {
                        <div class="col-lg-4 col-md-6">
                            <div class="product__item">
                                <div class="product__item__pic set-bg" data-setbg=@Url.Content("../img/products/" + item.ImageUrl)>
                                    <ul class="product__hover">
                                        <li>
                                            <a href=@Url.Content("../img/products/" + item.ImageUrl) class="image-popup">
                                                <span>
                                                    <i class="fas fa-expand-alt"></i>
                                                </span>
                                            </a>
                                        </li>
                                        <li>
                                            <a asp-controller="cart"
                                               asp-action="add"
                                               asp-route-id="@item.Id"
                                               asp-route-quantity=1>
                                                <span>
                                                    <i class="fas fa-shopping-cart"></i>
                                                </span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="product__item__text">
                                    <h6>
                                        <a asp-controller="products"
                                           asp-action="details"
                                           asp-route-id="@item.Id">
                                            @item.Name
                                        </a>
                                    </h6>
                                    <div class="product__price">@(item.Price.ToString("n0")) &#8363;</div>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="col-lg-12 text-center">
                        @Html.PagedListPager(Model,page=>Url.Action("Index", new {page = page}),
                        new PagedListRenderOptions()
                        {
                            MaximumPageNumbersToDisplay = 5,
                            PageClasses = new List<String> { "pagination__option" },
                            UlElementClasses = new List<String> { "pagination pagination__center" },
                            LiElementClasses = new List<String> { "pagination__option pagination__margin" },
                            ActiveLiElementClass = "pagination__active",
                        })
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Shop Section End --> *@

@* 
@{
    // Xử lý tiêu đề động
    string pageTitle = "Danh sách sản phẩm";
    if (!string.IsNullOrEmpty(ViewBag.search))
    {
        pageTitle = $"Tìm kiếm: {ViewBag.search}";
    }
    else if (!string.IsNullOrEmpty(ViewBag.CategoryName))
    {
        pageTitle = $"Loại: {ViewBag.CategoryName}";
    }

    ViewData["Title"] = pageTitle;
    ViewData["Products"] = "active";
}

@using X.PagedList.Mvc.Core
@using X.PagedList
@model X.PagedList.IPagedList<TbProduct>

<div class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__links">
                    <a asp-controller="home" asp-action="index">
                        <i class="fas fa-home"></i> Trang chủ
                    </a>
                    <span>@pageTitle</span>
                </div>
            </div>
        </div>
    </div>
</div>

<section class="shop spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-3">
                <div class="shop__sidebar">
                    <div class="sidebar__categories">
                        <div class="section-title">
                            <h4>Loại sản phẩm</h4>
                        </div>
                        @await Component.InvokeAsync("NhomSpMenu")
                    </div>
                </div>
            </div>

            <div class="col-lg-9 col-md-9">
                <div class="products-title" style="margin-bottom: 30px; border-bottom: 1px solid #e1e1e1; padding-bottom: 10px;">
                    <h4>@pageTitle</h4>
                </div>

                <div id="displayProducts" class="row">
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var item in Model)
                        {
                            <div class="col-lg-4 col-md-6">
                                <div class="product__item">
                                    <div class="product__item__pic set-bg" data-setbg="@Url.Content("~/img/products/" + item.ImageUrl)">
                                        <ul class="product__hover">
                                            <li>
                                                <a href="@Url.Content("~/img/products/" + item.ImageUrl)" class="image-popup">
                                                    <span><i class="fas fa-expand-alt"></i></span>
                                                </a>
                                            </li>
                                            <li>
                                                <a asp-controller="cart" asp-action="add" asp-route-id="@item.Id" asp-route-quantity="1">
                                                    <span><i class="fas fa-shopping-cart"></i></span>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="product__item__text">
                                        <h6>
                                            <a asp-controller="products" asp-action="details" asp-route-id="@item.Id">
                                                @item.Name
                                            </a>
                                        </h6>
                                        <div class="product__price">@(item.Price.ToString("n0")) &#8363;</div>
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="col-lg-12 text-center">
                            @Html.PagedListPager(Model, page => Url.Action("Index", new
                            {
                                page = page,
                                                search = ViewBag.search,       // Giữ từ khóa tìm kiếm
                                                categoryID = ViewBag.categoryID // Giữ ID loại sản phẩm
                                                }),
                                                new PagedListRenderOptions()
                                                {
                                                    MaximumPageNumbersToDisplay = 5,
                                                    PageClasses = new List<String> { "pagination__option" },
                                                    UlElementClasses = new List<String> { "pagination pagination__center" },
                                                    LiElementClasses = new List<String> { "pagination__option pagination__margin" },
                                                    ActiveLiElementClass = "pagination__active",
                                                })
                    </div>
                                        }
                    else
                    {
                        <div class="col-12 text-center">
                            <p>Không tìm thấy sản phẩm nào.</p>
                            <a asp-action="Index" class="btn btn-primary" style="background: #e53637; border: none;">Xem tất cả</a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</section> *@


@{
    ViewData["Title"] = "Sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="shop spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-3">
                <div class="shop__sidebar">
                    <div class="sidebar__categories">
                        <div class="section-title"><h4>Loại sản phẩm</h4></div>
                        @await Component.InvokeAsync("NhomSpMenu")
                    </div>
                </div>
            </div>
            <div class="col-lg-9 col-md-9">

                <div class="products-title mb-4">
                    <h4>Danh sách sản phẩm</h4>
                </div>

                <div id="displayProducts">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Đang tải...
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>
@* 
@section Scripts {
    <script>
        // Hàm gọi AJAX chính
        // page: trang số mấy
        // search: từ khóa tìm kiếm
        // cateID: ID loại sản phẩm
        function loadProducts(page, search, cateID) {

            // Hiển thị hiệu ứng loading (tùy chọn)
            // $('#displayProducts').html('<div class="text-center">Đang tải...</div>');

            $.ajax({
                url: '/Products/GetProductList', // Gọi action trong Controller
                type: 'GET',
                data: {
                    page: page,
                    search: search,
                    categoryID: cateID
                },
                success: function (response) {
                    // Server trả về HTML -> Đổ vào div
                    $('#displayProducts').html(response);
                },
                error: function (xhr) {
                    console.log(xhr.responseText);
                    alert('Có lỗi xảy ra khi tải dữ liệu.');
                }
            });
        }

        // Tự động tải trang 1 khi vừa vào trang web
        // $(document).ready(function () {
        //     loadProducts(1, '', null);
        // });
        $(document).ready(function () {
            // 1. Lấy giá trị từ ViewBag (Server) gán vào biến JS
            // Sử dụng Html.Raw để đảm bảo chuỗi không bị mã hóa sai
            var initialSearch = '@Html.Raw(ViewBag.CurrentSearch)';
            var initialCateID = '@ViewBag.CurrentCategoryID';

            // Chuyển categoryID về null nếu rỗng (để tránh lỗi logic)
            if(initialCateID === '') initialCateID = null;

            // 2. Gọi hàm loadProducts với dữ liệu lấy được
            loadProducts(1, initialSearch, initialCateID);
        });
    </script>
} *@

@section Scripts {
    <script>
        // --- Hàm gọi AJAX (Code cũ của bạn) ---
        function loadProducts(page, search, cateID) {
            // Hiển thị loading
            $('#displayProducts').html('<div class="text-center mt-5"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Đang tìm kiếm...</p></div>');

            $.ajax({
                url: '/Products/GetProductList',
                type: 'GET',
                data: {
                    page: page,
                    search: search,
                    categoryID: cateID
                },
                success: function (response) {
                    $('#displayProducts').html(response);

                    // Kích hoạt lại ảnh nền (Fix lỗi mất ảnh)
                    $('.set-bg').each(function () {
                        var bg = $(this).data('setbg');
                        $(this).css('background-image', 'url(' + bg + ')');
                    });
                },
                error: function (xhr) {
                    console.log(xhr.responseText);
                }
            });
        }

        // --- Code MỚI: Xử lý tìm kiếm từ Header ---

        // 1. Hàm thực hiện tìm kiếm (được gọi khi bấm nút kính lúp)
        window.performSearch = function() {
            var keyword = $('#searchInput').val(); // Lấy từ khóa từ Header

            // Cập nhật tiêu đề trang cho đẹp
            if(keyword) {
                $('.products-title h4').html('Kết quả tìm kiếm: <span class="text-danger">"' + keyword + '"</span>');
            } else {
                $('.products-title h4').text('Danh sách sản phẩm');
            }

            // Gọi AJAX về trang 1, với từ khóa vừa nhập, giữ nguyên Category (nếu cần thì để null)
            loadProducts(1, keyword, null);
        };

        // 2. Bắt sự kiện nhấn Enter trong ô input
        $(document).on('keypress', '#searchInput', function(e) {
            if(e.which == 13) { // Mã phím Enter
                performSearch();
                return false; // Chặn reload trang
            }
        });

        // 3. Load mặc định khi vào trang
        $(document).ready(function () {
            // Nếu có sẵn từ khóa từ ViewBag (trường hợp vào thẳng link có query)
            var initialSearch = '@Html.Raw(ViewBag.CurrentSearch)';
            if(initialSearch) {
                $('#searchInput').val(initialSearch); // Điền lại vào ô input
                loadProducts(1, initialSearch, null);
            } else {
                loadProducts(1, '', null);
            }
        });
    </script>
}