

@{
    ViewData["Title"] = "Sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="shop spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-3">
                <div class="shop__sidebar">
                    <div class="sidebar__categories">
                        <div class="section-title"><h4>Loại sản phẩm</h4></div>
                        @await Component.InvokeAsync("NhomSpMenu")
                    </div>
                </div>
            </div>
            <div class="col-lg-9 col-md-9">

                <div class="products-title mb-4">
                    <h4>Danh sách sản phẩm</h4>
                </div>

                <div id="displayProducts">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Đang tải...
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // --- Hàm gọi AJAX (Code cũ của bạn) ---
        function loadProducts(page, search, cateID) {
            // Hiển thị loading
            $('#displayProducts').html('<div class="text-center mt-5"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Đang tìm kiếm...</p></div>');

            $.ajax({
                url: '/Products/GetProductList',
                type: 'GET',
                data: {
                    page: page,
                    search: search,
                    categoryID: cateID
                },
                success: function (response) {
                    $('#displayProducts').html(response);

                    // Kích hoạt lại ảnh nền (Fix lỗi mất ảnh)
                    $('.set-bg').each(function () {
                        var bg = $(this).data('setbg');
                        $(this).css('background-image', 'url(' + bg + ')');
                    });
                },
                error: function (xhr) {
                    console.log(xhr.responseText);
                }
            });
        }


        // 1. Hàm thực hiện tìm kiếm (được gọi khi bấm nút kính lúp)
        window.performSearch = function() {
            var keyword = $('#searchInput').val(); // Lấy từ khóa từ Header

            // Cập nhật tiêu đề trang cho đẹp
            if(keyword) {
                $('.products-title h4').html('Kết quả tìm kiếm: <span class="text-danger">"' + keyword + '"</span>');
            } else {
                $('.products-title h4').text('Danh sách sản phẩm');
            }

            // Gọi AJAX về trang 1, với từ khóa vừa nhập, giữ nguyên Category (nếu cần thì để null)
            loadProducts(1, keyword, null);
        };

        // 2. Bắt sự kiện nhấn Enter trong ô input
        $(document).on('keypress', '#searchInput', function(e) {
            if(e.which == 13) { // Mã phím Enter
                performSearch();
                return false; // Chặn reload trang
            }
        });

        // 3. Load mặc định khi vào trang
        $(document).ready(function () {
            // Nếu có sẵn từ khóa từ ViewBag (trường hợp vào thẳng link có query)
            var initialSearch = '@Html.Raw(ViewBag.CurrentSearch)';
            if(initialSearch) {
                $('#searchInput').val(initialSearch); // Điền lại vào ô input
                loadProducts(1, initialSearch, null);
            } else {
                loadProducts(1, '', null);
            }
        });
    </script>
}